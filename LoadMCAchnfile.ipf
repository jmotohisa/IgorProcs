#include <Value Report>#include <strings as lists>#include "GraphPlot"#include "wname"// loadMCAchnfile.ipf//	Macro to load chn data file of SEIKO WinMCA//	07/02/17 ver. 0.11 by J. Motohisa////	revision history//		?/?/?		ver 0.1	first version//		07/02/17	ver 0.11 modified for newest IgorProMacro MultiChnLoad(thePath,flag,wantToPrint)	String thePath="_New Path_"	Prompt thePath, "Name of path containing text files", popup PathList("*", ";", "")+"_New Path_"	Variable flag=2	Prompt flag,"swap channel ?",popup,"no;yes"	Variable wantToPrint=2	Prompt wantToPrint, "Do you want to print graphs?", popup, "Yes;No"//	String ftype="sGBW"//	String ftype="TEXT"	String ftype=".chn"	//Prompt ftype,"Filetype"		Silent 1		String fileName	Variable fileIndex=0, gotFile		if (CmpStr(thePath, "_New Path_") == 0)		// user selected new path ?		NewPath/O data			// this brings up dialog and creates or overwrites path		thePath = "data"	endif		DoWindow /F Graphplot							// make sure Graphplot is front window	if (V_flag == 0)								// Graphplot does not exist?		Make/N=2/D/O dummywave0		Graphplot()									// create it	endif		do		fileName = IndexedFile($thePath,fileIndex,ftype)			// get name of next file in path		gotFile = CmpStr(fileName, "")		if (gotFile)			print fileName,thePath,flag			 ReadChn(fileName,thePath,"",flag)			//LoadWave/G/P=$thePath/O/N=wave fileName		// load the waves from file			Textbox/C/N=tb_file/F=0/A=MT/X=-30/Y=5 "File: "+fileName			DoUpdate		// make sure graph updated before printing			if (wantToPrint == 1)				PrintGraphs/R Graphplot(2, 2, 98, 98)/F=1	// print graph			endif		endif		fileIndex += 1	while (gotFile)									// until TextFile runs out of filesEndMacroMacro ReadChn(fileName,pathName,waveName,flag)	String fileName,pathName="home",waveName	Variable flag=2	Prompt flag,"swap channel ?",popup,"no;yes"		Silent 1; PauseUpDate		Variable /D ref	Variable IFlag,INo,ISeg,IReal,ILive,IStach,ISize		if (strlen(fileName)<=0)		Open /D/R/P=$pathName/T="sGBWTEXT" ref		fileName= S_fileName	endif	print fileName	if (strlen(waveName)<1)		waveName="chn"+wname(fileName)	endif	Open /R/P=$pathName/T="sGBWTEXT" ref as fileName	FsetPos ref,0	FBinRead /F=2/B ref,IFlag	FsetPos ref,2	FBinRead /F=2/B ref,INo	FsetPos ref,4	FBinRead /F=2/B ref,ISeg	FsetPos ref,8	FBinRead /F=3/B ref,IReal	FsetPos ref,12	FBinRead /F=3/B ref,ILive	FsetPos ref,28	FBinRead /F=2/B ref,IStach	FsetPos ref,30	FBinRead /F=2/B ref,ISize	Close ref//	Print IFlag,INo,ISeg,IReal,ILive,IStach,ISize		GBLoadWave/N=$"dummywave"/B/F=1/S=32/W=1/U=(ISize)/P=$pathName fileName// swap//	waveName = GetStrFromList(S_waveNames,0,";")	if(flag==2) then		Duplicate/O dummywave0,tmpwave		tmpwave = -x		Sort tmpwave tmpwave,dummywave0		KillWaves/Z tmpwave	endif//	duplicate dummywave0,$waveNameEnd MacroMacro ScaleChn(waveName,gain,range)	String waveName	Variable/D gain=10,range = 50	Prompt waveName,"waveName",popup,WaveList("chn*", ";", "")	Prompt gain,"TAC Gain"	Prompt range,"TAC Range (nsec)"		Silent 1; PauseUpDate	Variable/D dt		WaveStats/Q $waveName	dt = range/ gain*1e-9/V_npnts	SetScale /P x,0,dt,"sec",$waveNameEnd MacroMacro DisplayChn(waveName)	String waveName	Prompt waveName,"waveName",popup,WaveList("chn*", ";", "")		Silent 1; PauseUpDate	Display $waveName	ModifyGraph log(left)=1End MacroMacro DisplayChnAll()	Silent 1; PauseUpDate	variable index=0	String chnlist = WaveList("chn*",";","")	String waveName	do		waveName = GetStrFromList(chnlist,index,";")		if(strlen(waveName) ==0)			break		endif		DisplayChn(waveName)		index +=1	while(1)End MacroMacro ShiftXChn(waveName,x0,gain,range)	String waveName	Variable/D x0=0,gain=10,range = 50	Prompt waveName,"waveName",popup,WaveList("chn*", ";", "")	Prompt x0,"Number of x points for shift (from 0)"	Prompt gain,"TAC Gain"	Prompt range,"TAC Range (nsec)"		Silent 1; PauseUpDate	Variable/D dt	WaveStats/Q $waveName	dt = range/ gain*1e-9/V_npnts	x0 = -x0*dt	SetScale /P x,x0,dt,"sec",$waveNameEnd MacroMacro DupAndSmChn(waveName)	String waveName	Prompt waveName,"chn wave name to duplicate and smooth",popup,WaveList("chn*", ";", "")	Silent 1; PauseUpDate		String tmp,str		tmp = waveName + "_s"	duplicate/O $waveName,$tmp		Smooth 5,$tmp	Display /W=(5,42,617,439) $tmp	ModifyGraph log(left)=1	SetAxis bottom 5e-10,3e-09	str = "\s("+tmp+") " + tmp + "\r"	Tag/N=text0/F=0/X=90.04/Y=-30.07/L=0 $tmp, 0,str	ShowInfoEnd MacroMacro TRPLfit(waveName,k0flag,apflag,aflag)// fitting by single exponential with k0=0	String waveName	Variable k0flag=2,aflag=1,apflag = 1	Prompt waveName,"wave name",popup,WaveList("chn*", ";", "WIN:")	Prompt k0flag,"Set K0 to be 0",popup,"yes;no"	Prompt apflag,"Append as new fit results?",popup,"yes;no"	Prompt aflag,"Display Fit Results ?",popup,"yes;no"	Silent 1; PauseUpDate	// curve fit result a0+a1*exp(-t/tau)	String str_tau,str_a0,str_a1	String str_textbox,str_fitres="fitres",annonlist,str	Variable/D tauinv	Variable index = 0	annonlist = AnnotationList("")	do		str = str_fitres + num2istr(index)		if(strsearch(annonlist,str,0)<0)			break		endif		index +=1	while(1)		if(k0flag==1)		K0=0		CurveFit/Q/H="100" exp $waveName(xcsr(A),xcsr(B)) /D		tauinv = 1/W_coef[2]*1e12//		str_a0 = MakeValueReportString(W_coef[0],0,0,"",1)		str_a1 = MakeValueReportString(W_coef[1],0,0,"",1)		str_tau = MakeValueReportString(tauinv,0,0,"psec",1)		str_textbox = "tau = " + str_tau + "\r"//		str_textbox = str_textbox + "a0=" + str_a0 + "\r"		str_textbox = str_textbox + "a1=" + str_a1	else		CurveFit/Q exp $waveName(xcsr(A),xcsr(B)) /D		tauinv = 1/W_coef[2]*1e12		str_a0 = MakeValueReportString(W_coef[0],0,0,"",1)		str_a1 = MakeValueReportString(W_coef[1],0,0,"",1)		str_tau = MakeValueReportString(tauinv,0,0,"psec",1)		str_textbox = "tau = " + str_tau + "\r"		str_textbox = str_textbox + "a0=" + str_a0 + "\r"		str_textbox = str_textbox + "a1=" + str_a1	endif//	Print "number of iteration is = "//,V_FitNumIters	if(apflag==1 %| index==0) then		Textbox/N=$str/F=0/A=MC/X=26.52/Y=28.30 str_textbox	else		index -=1		str = str_fitres + num2istr(index)		Textbox/C/N=$str/F=0/A=MC/X=26.52/Y=28.30 str_textbox	endif	if(aflag==1)		AppendFitResults(waveName,index)	endifEnd MacroMacro TRPLfit2(waveName,k0flag,apflag,aflag)// fitting by double exponential	String waveName	Variable k0flag=2,aflag=1,apflag = 1	Prompt waveName,"wave name",popup,WaveList("chn*", ";", "WIN:")	Prompt k0flag,"Set K0 to be 0",popup,"yes;no"	Prompt apflag,"Append as new fit results?",popup,"yes;no"	Prompt aflag,"Display Fit Results ?",popup,"yes;no"	Silent 1; PauseUpDate	// curve fit result a0+a1*exp(-t/tau1) + a2 * exp(-t/tau2)	String str_tau1, str_tau2,str_a0,str_a1,str_a2	String str_textbox,str_fitres="fitres",annonlist,str	Variable/D tau1inv,tau2inv	Variable index = 0	annonlist = AnnotationList("")	do		str = str_fitres + num2istr(index)		if(strsearch(annonlist,str,0)<0)			break		endif		index +=1	while(1)		if(k0flag==1)		K0=0		CurveFit/Q/H="10000" dblexp $waveName(xcsr(A),xcsr(B)) /D		tau1inv = 1/W_coef[2]*1e12		tau2inv = 1/W_coef[4]*1e12//		str_a0 = MakeValueReportString(W_coef[0],0,0,"",1)		str_a1 = MakeValueReportString(W_coef[1],0,0,"",1)		str_tau1 = MakeValueReportString(tau1inv,0,0,"psec",1)		str_a2 = MakeValueReportString(W_coef[3],0,0,"",1)		str_tau2 = MakeValueReportString(tau2inv,0,0,"psec",1)		str_textbox = "tau1 = " + str_tau1 + "\r"		str_textbox = str_textbox + "tau2 = " + str_tau2 + "\r"//		str_textbox = str_textbox + "a0=" + str_a0 + "\r"		str_textbox = str_textbox + "a1=" + str_a1 + "\r"		str_textbox = str_textbox + "a2=" + str_a2	else		CurveFit/Q dblexp $waveName(xcsr(A),xcsr(B)) /D		tau1inv = 1/W_coef[2]*1e12		tau2inv = 1/W_coef[4]*1e12		str_a0 = MakeValueReportString(W_coef[0],0,0,"",1)		str_a1 = MakeValueReportString(W_coef[1],0,0,"",1)		str_tau1 = MakeValueReportString(tau1inv,0,0,"psec",1)		str_a2 = MakeValueReportString(W_coef[3],0,0,"",1)		str_tau2 = MakeValueReportString(tau2inv,0,0,"psec",1)		str_textbox = "tau1 = " + str_tau1 + "\r"		str_textbox = str_textbox + "tau2 = " + str_tau2 + "\r"		str_textbox = str_textbox + "a0=" + str_a0 + "\r"		str_textbox = str_textbox + "a1=" + str_a1 + "\r"		str_textbox = str_textbox + "a2=" + str_a2	endif//	Print "number of iteration is = "//,V_FitNumIters	if(apflag==1 %| index==0) then		Textbox/N=$str/F=0/A=MC/X=26.52/Y=28.30 str_textbox	else		index -=1		str = str_fitres + num2istr(index)		Textbox/C/N=$str/F=0/A=MC/X=26.52/Y=28.30 str_textbox	endif	if(aflag==1)		AppendFit2Results(waveName,index)	endifEnd MacroMacro DefineGrobal_ExpFit()	String/G g_graphname	String/G g_stdwave	String/G g_origWaveList	String/G g_dstwave	Variable/G g_ymin,g_ymax,g_offsetEndMacroMacro InitExpFit(waveName)| initialization for Exponential Fit|	String grname=WinName(0, 1)	String waveName=WaveName("",0,1)|	Prompt grname,"Graph to create multiple axes",popup,WinList("*",";","WIN:1")	Prompt swave,"Wave name to fit",popup,WaveList("chn*",";","")|	Prompt gnewname,"New graph name"	PauseUpdate; Silent 1		String grname		grname = "ExpFit:"+waveName	g_stdwave=waveName	g_graphname=grname|	g_origWaveList=WaveList("*",";","WIN:"+grname)	Display /W=(3,41,636,476) $waveName	DoWindow/C "ExpFit:"+waveNameEndMacroMacro ExpFit_Step1(waveName,grname,smflag)End MacroMacro AppendFitResults(waveName,index)	String waveName	Variable index	Prompt waveName,"wave name",popup,WaveList("chn*", ";", "WIN:")	Prompt index,"index"		String wave2		wave2 = "fit0_" + num2istr(index) + "_"+ waveName	Duplicate/O $waveName,$wave2		$wave2 = W_coef[0] + W_coef[1] * exp(-W_coef[2]*x)		if(strsearch(WaveList("*",";","WIN:"),wave2,0)<0) 		AppendToGraph $wave2		ModifyGraph rgb($wave2)=(0,0,65535)	endifEnd MacroMacro AppendFit2Results(waveName,index)	String waveName	Variable index	Prompt waveName,"wave name",popup,WaveList("chn*", ";", "WIN:")		String wave2		wave2 = "fit0_" + num2istr(index) + "_"+ waveName	Duplicate/O $waveName,$wave2		$wave2 = W_coef[0] + W_coef[1] * exp(-W_coef[2]*x) + W_coef[3] * exp(-W_coef[4]*x)	if(strsearch(WaveList("*",";","WIN:"),wave2,0)<0) 		AppendToGraph $wave2		ModifyGraph rgb($wave2)=(0,0,65535)	endifEnd Macro